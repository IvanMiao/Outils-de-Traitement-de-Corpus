# 詩分唐宋：诗歌-朝代分类

## 环境管理

本项目使用 `uv` 管理Python环境。

运行方式（请确保已安装 `uv`）：
```bash
uv run path/to/script.py
```

## 项目目标

本项目旨在对中国古典诗歌（不含词、曲）进行文本分类，预测诗歌所属朝代（按时间顺序分为：魏晋、南北朝、唐、宋、元、明、清）。

虽然中国古典诗歌形式在唐代后趋于稳定，但本研究的开展基于两点观察：

1. 语言特征：不同朝代的诗歌在用词习惯和语言特征上存在差异

2. 文体学/风格学特征：中国古代文论中常强调各朝代诗歌的独特风格，这种"时代精神"（zeitgeist）具有可辨识性

## 数据说明

数据来源于搜韵网（sou-yun.cn）。

该网站已按朝代对诗歌进行分类，并提供了按作者分类的诗歌索引。项目使用 `request` 和 `bs4` 解析网页 HTML 结构，从选定的七个朝代中抓取诗歌数据。为提高训练效率，采用分级抓取策略：

- 诗人数量不足1000的朝代：抓取每位诗人前20首作品（不足则取全部）

- 作品量大的朝代：仅抓取前1000位诗人的前20首作品

数据获取后以 `.csv` 格式保存，经合并、打乱后划分为训练集/验证集/测试集（比例为 **7 : 1.5 : 1.5**，实际数量为 **17418 : 3733 : 3738**），存储为HuggingFace数据集格式。

| 数据集    | 比例 | 实际数量 |
|-----------|------|----------|
| 训练集    | 7    | 17 418   |
| 验证集    | 1.5  | 3 733    |
| 测试集    | 1.5  | 3 738    |
| **总计**  | **10** | **24 889** |

数据分布如下所示：

![](../figures/dynasty_poems_stats.png)

前两个朝代（魏晋和南北朝）数据量最少，这符合历史实际——年代越久远，存世作品越少。魏晋诗歌的平均长度最长，因为在本数据集/语料库中，**赋**也被视为诗歌。而魏晋时期长篇四言诗和赋的创作比例高于其他六个朝代。唐代后盛行的**绝句**（24或32字，包含标点）和**律诗** (48或64字)成为诗歌主流。但考虑到古体诗和赋都偶有创作，且它们远长于“绝句”和“律诗”，因此获得的各朝代诗歌平均长度（60-80字）是合理的。

## 模型训练

本项目以 [HuggingFace Text Classification](https://huggingface.co/docs/transformers/en/tasks/sequence_classification) 为参考，对以下三个BERT类预训练模型进行微调：

1. `distilled-bert-multilingual`：蒸馏版多语言BERT，训练速度快
2. `bert-case-chinese`：针对中文的 BERT 模型
3. `ethanyt/guwenbert-base`：基于 bert-case-chinese，并已在大量古典中文文本语料库上进行过微调的模型

第一个模型的 epoch 设置为3。为了减少训练时间，对于另外两个更大的模型，epoch 设置为2。其他参数保持不变。

训练日志显示各模型在验证集上的损失变化：

![](../figures/training_analysis.png)

三个模型的损失趋势总体相似，其中 `bert-case-chinese` 和 `ethanyt/guwenbert-base` 近乎平行———这或许是因为后者是在前者基础上进行微调的。值得注意的是，蒸馏模型在第二轮后出现验证损失上升的现象，但由于时间和资源限制，未能对另外两个较大模型进行更多轮次训练来观察类似现象。

## 评估

使用测试集评估三个模型，通过 `sklearn` 的 `classification_report` 生成详细指标。

**精确率**：在所有被模型预测为某个朝代的诗歌中，真正属于该朝代的诗歌所占的比例。例如，如果模型预测了100首诗为唐诗，其中80首确实是唐诗，那么唐诗这个类别的精确率就是80%。精确率高表示模型预测的结果比较“准”，不轻易将其他朝代的诗误判为该朝代。

**召回率**：在所有真实属于某个朝代的诗歌中，被模型成功预测出来的诗歌所占的比例。例如，数据集中实际有100首唐诗，模型成功找出了其中的70首，那么唐诗这个类别的召回率就是70%。召回率高表示模型能把该朝代的诗歌尽可能多地“找全”，不轻易漏掉。

**F1**：精确率和召回率的调和平均数，综合了上述两个指标。

`distilled-bert-multilingual` 模型，结果如下：

| 朝代   | 精确率 | 召回率 | F1 | 样本数 |
|--------|--------|--------|--------|--------|
| 魏晋   | 0.5627 | 0.8248 | 0.6690 | 234    |
| 南北朝 | 0.5986 | 0.5397 | 0.5676 | 315    |
| 唐     | 0.4953 | 0.3680 | 0.4222 | 568    |
| 宋     | 0.3553 | 0.1211 | 0.1806 | 446    |
| 元     | 0.4140 | 0.5115 | 0.4576 | 823    |
| 明     | 0.3389 | 0.3632 | 0.3506 | 782    |
| 清     | 0.3768 | 0.4509 | 0.4105 | 570    |
| **准确率** |        |        | 0.4248 | 3738   |
| **宏观平均** | 0.4488 | 0.4542 | 0.4369 | 3738   |
| **加权平均** | 0.4228 | 0.4248 | 0.4121 | 3738   |

<br>

`bert-case-chinese` 模型，结果如下：

| 朝代   | 精确率 | 召回率 | F1 | 样本数 |
|--------|--------|--------|--------|--------|
| 魏晋   | 0.6565 | 0.7350 | 0.6935 | 234    |
| 南北朝 | 0.5994 | 0.6032 | 0.6013 | 315    |
| 唐     | 0.4110 | 0.5898 | 0.4845 | 568    |
| 宋     | 0.3103 | 0.1413 | 0.1941 | 446    |
| 元     | 0.4183 | 0.5322 | 0.4684 | 823    |
| 明     | 0.3789 | 0.4003 | 0.3893 | 782    |
| 清     | 0.5858 | 0.2754 | 0.3747 | 570    |
| **准确率** |        |        | 0.4462 | 3738   |
| **宏观平均** | 0.4800 | 0.4682 | 0.4580 | 3738   |
| **加权平均** | 0.4518 | 0.4462 | 0.4326 | 3738   |

<br>

`ethanyt/guwenbert-base` 模型，结果如下：

| 朝代   | 精确率 | 召回率 | F1 | 样本数 |
|--------|--------|--------|--------|--------|
| 魏晋   | 0.7626 | 0.8376 | 0.7984 | 234    |
| 南北朝 | 0.7953 | 0.6413 | 0.7100 | 315    |
| 唐     | 0.5686 | 0.5546 | 0.5615 | 568    |
| 宋     | 0.4163 | 0.2287 | 0.2952 | 446    |
| 元     | 0.4060 | 0.6877 | 0.5106 | 823    |
| 明     | 0.3853 | 0.4361 | 0.4091 | 782    |
| 清     | 0.7718 | 0.2018 | 0.3199 | 570    |
| **准确率** |        |        | 0.4914 | 3738   |
| **宏观平均** | 0.5866 | 0.5125 | 0.5150 | 3738   |
| **加权平均** | 0.5385 | 0.4914 | 0.4771 | 3738   |

<br>

各朝代召回率（即每个朝代诗歌的正确预测率）对比图：

![](../figures/evaluate_analysis.png)

`ethanyt/guwenbert-base` 作为专门针对古典中文的模型，表现最佳，准确率（accuracy）为0.4914，宏观 F1（macro F1-score）为0.5150。其次是 `bert-case-chinese`（准确率 0.4462，宏观 F1 0.4580），然后是 `distilled-bert-multilingual`（准确率 0.4248，宏观 F1 0.4369）。

魏晋诗歌识别率最高，可能因其语言特征、文体特征鲜明。

宋代诗歌最难区分，或因其承前启后特征明显。或者是因为样本量相对于元明清过少。

清代诗歌识别率低，可能因古汉语BERT侧重早期文言特征。

## 标准

项目代码使用 `pycodestyle` 进行核对，确保其符合 PEP 8 规范。